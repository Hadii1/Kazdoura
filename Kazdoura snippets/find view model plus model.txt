package com.Czynt.kazdoura.Find;

import android.util.Log;

import androidx.lifecycle.MutableLiveData;

import com.Czynt.kazdoura.Store;
import com.google.android.gms.tasks.Task;
import com.google.firebase.firestore.FirebaseFirestore;
import com.google.firebase.firestore.QueryDocumentSnapshot;
import com.google.firebase.firestore.QuerySnapshot;

import org.imperiumlabs.geofirestore.GeoFirestore;

import java.util.ArrayList;

class FindModel {

    private FirebaseFirestore db;
    private static final String TAG = "FindModel";
    private final ArrayList<Store> stores = new ArrayList<>();
    private static FindModel findModel;
    private OnStoresQueryCallback callback;

    synchronized static FindModel getInstance() {

        if (findModel == null) {
            findModel = new FindModel();
        }
        return findModel;
    }

    private FindModel() {

        db = FirebaseFirestore.getInstance();

    }


    void getStores(String type, OnStoresQueryCallback callback) {

        this.callback = callback;

        final MutableLiveData<ArrayList<Store>> data = new MutableLiveData<>();

        if (data.getValue() != null) {

            data.getValue().clear();

        }

        stores.clear();


        Task<QuerySnapshot> task = db.collection("Stores").whereEqualTo("type", type).limit(30).get();
        task.addOnSuccessListener(queryDocumentSnapshots -> {

            Log.d(TAG, "getStores Success");

            for (QueryDocumentSnapshot qds : queryDocumentSnapshots) {

                Store store = qds.toObject(Store.class);

                stores.add(store);

            }
            //The following is done on the main thread

            data.setValue(stores);

            this.callback.getStoresSuccess(data);

        });

        task.addOnFailureListener(e -> this.callback.getStoresFailed());


    }

    void clearReference() {
        if (this.callback != null) {
            this.callback = null;
        }
    }


    interface OnStoresQueryCallback {

        void getStoresSuccess(MutableLiveData<ArrayList<Store>> stores);

        void getStoresFailed();
    }
}




















package com.Czynt.kazdoura.Find;

import android.util.Log;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import com.Czynt.kazdoura.Store;

import java.util.ArrayList;

public class FindViewModel extends ViewModel implements {

    private final static String TAG = "FindViewModel";
    private MutableLiveData<ArrayList<Store>> stores = new MutableLiveData<>();
    private MutableLiveData<Boolean> isUpdating = new MutableLiveData<>();
    private MutableLiveData<Boolean> noStores = new MutableLiveData<>();
    private MutableLiveData<Boolean> failed = new MutableLiveData<>();
    private FindModel model;


    public FindViewModel() {

        model = FindModel.getInstance();

    }


    LiveData<ArrayList<Store>> getStores() {


        if (stores.getValue() == null) {
            stores.setValue(new ArrayList<>());
        }


        return stores;
    }

    LiveData<Boolean> getIsUpdating() {
        return isUpdating;
    }

    LiveData<Boolean> getFailureFlag() {
        return failed;
    }

    LiveData<Boolean> getNoStoresAvailable() {
        return noStores;
    }

    void typeFilterClicked(String type) {

        isUpdating.setValue(true);

        model.getStores(type);

    }


    public void getStoresSuccess(MutableLiveData<ArrayList<Store>> stores) {

        noStores.setValue(false);
        isUpdating.setValue(false);

        if (stores.getValue() != null && stores.getValue().size() == 0) {

            noStores.setValue(true);

            Log.d(TAG, "getStoresSuccess: no Stores");

        } else {

            Log.d(TAG, "getStoresSuccess: stores available");

            this.stores.setValue(stores.getValue());
        }


    }


    public void getStoresFailed() {

        Log.d(TAG, "getStoresFailed: ");

        noStores.setValue(false);

        isUpdating.setValue(false);

        failed.setValue(true);

    }


}

